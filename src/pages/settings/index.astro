---
import AppLayout from '../../layouts/AppLayout.astro';
---

<AppLayout title="Configura√ß√µes - Arquivo Inteligente" currentPath="/settings">
    <div class="page-header">
        <h1 class="page-title">‚öôÔ∏è Configura√ß√µes</h1>
        <p class="page-subtitle">Gerencie departamentos e outras configura√ß√µes do sistema</p>
    </div>

    <div class="settings-grid">
        <section class="settings-section">
            <div class="section-header">
                <h2>üè¢ Departamentos</h2>
                <button type="button" class="btn-add" id="btn-add-dept">+ Adicionar</button>
            </div>
            <div class="section-content" id="departments-list">
                <div class="loading-message">Carregando...</div>
            </div>
        </section>

        <section class="settings-section">
            <div class="section-header">
                <h2>üìã Categorias de Documentos</h2>
            </div>
            <div class="section-content" id="categories-list">
                <div class="loading-message">Carregando...</div>
            </div>
        </section>
    </div>

    <!-- Modal for Add/Edit Department -->
    <dialog id="dept-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">Novo Departamento</h3>
            <form id="dept-form">
                <input type="hidden" id="dept-id" />
                <div class="form-group">
                    <label for="dept-name">Nome</label>
                    <input type="text" id="dept-name" required />
                </div>
                <div class="form-group">
                    <label for="dept-code">C√≥digo</label>
                    <input type="text" id="dept-code" required />
                </div>
                <div class="form-group">
                    <label for="dept-description">Descri√ß√£o</label>
                    <textarea id="dept-description" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" id="btn-cancel">Cancelar</button>
                    <button type="submit" class="btn-save">Salvar</button>
                </div>
            </form>
        </div>
    </dialog>
</AppLayout>

<style>
    .page-header {
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
        color: white;
    }

    .page-subtitle {
        color: rgba(255, 255, 255, 0.6);
        margin: 0.25rem 0 0;
        font-size: 0.9375rem;
    }

    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
    }

    .settings-section {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 16px;
        overflow: hidden;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.25rem;
        background: rgba(255, 255, 255, 0.02);
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .section-header h2 {
        margin: 0;
        font-size: 1rem;
        color: white;
    }

    .btn-add {
        padding: 0.375rem 0.75rem;
        background: rgba(59, 130, 246, 0.15);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 6px;
        color: #60a5fa;
        font-size: 0.8125rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-add:hover {
        background: rgba(59, 130, 246, 0.25);
    }

    .section-content {
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
    }

    .loading-message {
        text-align: center;
        padding: 2rem;
        color: rgba(255, 255, 255, 0.5);
    }

    .item-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        background: rgba(255, 255, 255, 0.02);
    }

    .item-row:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .item-info {
        display: flex;
        flex-direction: column;
    }

    .item-name {
        font-weight: 500;
        color: white;
    }

    .item-code {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.5);
    }

    .item-actions {
        display: flex;
        gap: 0.5rem;
    }

    .action-btn {
        padding: 0.25rem 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.75rem;
        cursor: pointer;
    }

    .action-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }

    /* Modal */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        padding: 0;
        max-width: 100%;
        max-height: 100%;
    }

    .modal::backdrop {
        background: rgba(0, 0, 0, 0.7);
    }

    .modal-content {
        background: #1e293b;
        border-radius: 16px;
        padding: 1.5rem;
        width: 100%;
        max-width: 400px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-content h3 {
        margin: 0 0 1.5rem;
        color: white;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.375rem;
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.7);
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 0.625rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: white;
        font-size: 0.9375rem;
    }

    .form-group input:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        margin-top: 1.5rem;
    }

    .btn-cancel {
        padding: 0.5rem 1rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
    }

    .btn-save {
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, #3b82f6, #6366f1);
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        cursor: pointer;
    }
</style>

<script>
    import { invoke } from '@tauri-apps/api/core';

    interface Department {
        id: number;
        name: string;
        code: string;
        description: string | null;
        is_active: boolean;
    }

    interface Category {
        id: number;
        name: string;
        code: string;
        icon: string | null;
        color: string | null;
    }

    const modal = document.getElementById('dept-modal') as HTMLDialogElement;

    async function loadDepartments() {
        const token = localStorage.getItem('archive_token');
        if (!token) {
            window.location.href = '/';
            return;
        }

        try {
            const result = await invoke('list_departments', { payload: { token } }) as { success: boolean; data?: Department[] };
            
            if (result.success && result.data) {
                const list = document.getElementById('departments-list')!;
                if (result.data.length === 0) {
                    list.innerHTML = '<div class="loading-message">Nenhum departamento cadastrado</div>';
                } else {
                    list.innerHTML = result.data.map(dept => `
                        <div class="item-row">
                            <div class="item-info">
                                <span class="item-name">${dept.name}</span>
                                <span class="item-code">${dept.code}</span>
                            </div>
                            <div class="item-actions">
                                <button class="action-btn" onclick="editDept(${dept.id}, '${dept.name}', '${dept.code}', '${dept.description || ''}')">‚úèÔ∏è</button>
                            </div>
                        </div>
                    `).join('');
                }
            }
        } catch (err) {
            console.error('Failed to load departments:', err);
        }
    }

    async function loadCategories() {
        const token = localStorage.getItem('archive_token');
        if (!token) return;

        try {
            const result = await invoke('list_document_categories', { payload: { token } }) as { success: boolean; data?: Category[] };
            
            if (result.success && result.data) {
                const list = document.getElementById('categories-list')!;
                list.innerHTML = result.data.map(cat => `
                    <div class="item-row">
                        <div class="item-info">
                            <span class="item-name">${cat.icon || 'üìÑ'} ${cat.name}</span>
                            <span class="item-code">${cat.code}</span>
                        </div>
                    </div>
                `).join('');
            }
        } catch (err) {
            console.error('Failed to load categories:', err);
        }
    }

    // Add department
    document.getElementById('btn-add-dept')?.addEventListener('click', () => {
        (document.getElementById('modal-title') as HTMLElement).textContent = 'Novo Departamento';
        (document.getElementById('dept-id') as HTMLInputElement).value = '';
        (document.getElementById('dept-name') as HTMLInputElement).value = '';
        (document.getElementById('dept-code') as HTMLInputElement).value = '';
        (document.getElementById('dept-description') as HTMLTextAreaElement).value = '';
        modal.showModal();
    });

    // Edit department
    (window as any).editDept = (id: number, name: string, code: string, description: string) => {
        (document.getElementById('modal-title') as HTMLElement).textContent = 'Editar Departamento';
        (document.getElementById('dept-id') as HTMLInputElement).value = id.toString();
        (document.getElementById('dept-name') as HTMLInputElement).value = name;
        (document.getElementById('dept-code') as HTMLInputElement).value = code;
        (document.getElementById('dept-description') as HTMLTextAreaElement).value = description;
        modal.showModal();
    };

    // Cancel
    document.getElementById('btn-cancel')?.addEventListener('click', () => {
        modal.close();
    });

    // Save
    document.getElementById('dept-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const token = localStorage.getItem('archive_token');
        if (!token) return;

        const id = (document.getElementById('dept-id') as HTMLInputElement).value;
        const name = (document.getElementById('dept-name') as HTMLInputElement).value;
        const code = (document.getElementById('dept-code') as HTMLInputElement).value;
        const description = (document.getElementById('dept-description') as HTMLTextAreaElement).value;

        try {
            if (id) {
                await invoke('update_department', {
                    payload: { token, id: parseInt(id) },
                    data: { name, code, description: description || null },
                });
            } else {
                await invoke('create_department', {
                    payload: { token, data: { name, code, description: description || null } },
                });
            }
            modal.close();
            loadDepartments();
        } catch (err) {
            console.error('Failed to save department:', err);
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        loadDepartments();
        loadCategories();
    });
</script>
