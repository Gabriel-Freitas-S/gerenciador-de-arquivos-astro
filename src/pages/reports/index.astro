---
import AppLayout from '../../layouts/AppLayout.astro';
---

<AppLayout title="Relat√≥rios - Arquivo Inteligente" currentPath="/reports">
    <div class="page-header">
        <h1 class="page-title">üìà Central de Relat√≥rios</h1>
        <p class="page-subtitle">Visualize m√©tricas e exporte dados</p>
    </div>

    <div class="reports-grid">
        <div class="report-card">
            <div class="report-icon">üë•</div>
            <h3>Funcion√°rios</h3>
            <p>Relat√≥rio completo de funcion√°rios ativos e demitidos</p>
            <button class="report-btn" data-report="employees">Visualizar</button>
        </div>

        <div class="report-card">
            <div class="report-icon">üìÅ</div>
            <h3>Empr√©stimos</h3>
            <p>Hist√≥rico de empr√©stimos e devolu√ß√µes</p>
            <button class="report-btn" data-report="loans">Visualizar</button>
        </div>

        <div class="report-card">
            <div class="report-icon">üóÑÔ∏è</div>
            <h3>Ocupa√ß√£o</h3>
            <p>Mapa de ocupa√ß√£o dos gaveteiros</p>
            <button class="report-btn" data-report="occupation">Visualizar</button>
        </div>

        <div class="report-card">
            <div class="report-icon">üìä</div>
            <h3>Movimenta√ß√µes</h3>
            <p>Hist√≥rico de todas as movimenta√ß√µes</p>
            <button class="report-btn" data-report="movements">Visualizar</button>
        </div>
    </div>

    <div class="report-viewer hidden" id="report-viewer">
        <div class="report-header">
            <h2 id="report-title">Relat√≥rio</h2>
            <button class="close-btn" id="close-report">‚úï Fechar</button>
        </div>
        <div class="report-content" id="report-content">
            Carregando...
        </div>
    </div>
</AppLayout>

<style>
    .page-header {
        margin-bottom: 2rem;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0;
        background: linear-gradient(135deg, #10b981, #14b8a6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .page-subtitle {
        color: rgba(255, 255, 255, 0.6);
        margin: 0.25rem 0 0;
        font-size: 0.9375rem;
    }

    .reports-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    .report-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 16px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.2s ease;
    }

    .report-card:hover {
        border-color: rgba(16, 185, 129, 0.3);
        background: rgba(16, 185, 129, 0.05);
    }

    .report-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }

    .report-card h3 {
        margin: 0 0 0.5rem;
        font-size: 1.125rem;
        color: white;
    }

    .report-card p {
        margin: 0 0 1.25rem;
        font-size: 0.875rem;
        color: rgba(255, 255, 255, 0.6);
    }

    .report-btn {
        padding: 0.625rem 1.5rem;
        background: linear-gradient(135deg, #10b981, #059669);
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .report-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .report-viewer {
        margin-top: 2rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 16px;
        overflow: hidden;
    }

    .report-viewer.hidden {
        display: none;
    }

    .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .report-header h2 {
        margin: 0;
        font-size: 1.125rem;
        color: white;
    }

    .close-btn {
        padding: 0.375rem 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.8125rem;
        cursor: pointer;
    }

    .report-content {
        padding: 1.5rem;
        min-height: 200px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-item {
        text-align: center;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 10px;
    }

    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: white;
    }

    .stat-label {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 0.25rem;
    }
</style>

<script>
    import { invoke } from '@tauri-apps/api/core';

    const reportViewer = document.getElementById('report-viewer');
    const reportTitle = document.getElementById('report-title');
    const reportContent = document.getElementById('report-content');

    document.querySelectorAll('.report-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const reportType = (e.target as HTMLElement).dataset.report;
            await loadReport(reportType!);
        });
    });

    document.getElementById('close-report')?.addEventListener('click', () => {
        reportViewer?.classList.add('hidden');
    });

    async function loadReport(type: string) {
        const token = sessionStorage.getItem('archive_token');
        if (!token) {
            window.location.href = '/';
            return;
        }

        reportViewer?.classList.remove('hidden');
        reportContent!.innerHTML = 'Carregando...';

        try {
            switch (type) {
                case 'loans':
                    const loansResult = await invoke('get_loans_report', { payload: { token } }) as any;
                    if (loansResult.success) {
                        reportTitle!.textContent = 'üìÅ Relat√≥rio de Empr√©stimos';
                        reportContent!.innerHTML = `
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-value">${loansResult.data.total_loans}</div>
                                    <div class="stat-label">Total</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${loansResult.data.open_loans}</div>
                                    <div class="stat-label">Em Aberto</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${loansResult.data.overdue_loans?.length || 0}</div>
                                    <div class="stat-label">Atrasados</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${loansResult.data.returned_today}</div>
                                    <div class="stat-label">Devolvidos Hoje</div>
                                </div>
                            </div>
                        `;
                    }
                    break;

                case 'movements':
                    const movResult = await invoke('get_movements_report', { payload: { token } }) as any;
                    if (movResult.success) {
                        reportTitle!.textContent = 'üìä Relat√≥rio de Movimenta√ß√µes';
                        const actions = Object.entries(movResult.data.by_action || {})
                            .map(([action, count]) => `<div class="stat-item"><div class="stat-value">${count}</div><div class="stat-label">${action}</div></div>`)
                            .join('');
                        reportContent!.innerHTML = `
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-value">${movResult.data.total_movements}</div>
                                    <div class="stat-label">Total de Movimenta√ß√µes</div>
                                </div>
                                ${actions}
                            </div>
                        `;
                    }
                    break;

                case 'occupation':
                    const occResult = await invoke('get_occupation_map', { payload: { token } }) as any;
                    if (occResult.success) {
                        reportTitle!.textContent = 'üóÑÔ∏è Relat√≥rio de Ocupa√ß√£o';
                        reportContent!.innerHTML = `
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-value">${occResult.data.totals.total_positions}</div>
                                    <div class="stat-label">Posi√ß√µes Totais</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${occResult.data.totals.occupied_positions}</div>
                                    <div class="stat-label">Ocupadas</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${occResult.data.totals.warnings}</div>
                                    <div class="stat-label">Em Alerta</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${occResult.data.totals.critical}</div>
                                    <div class="stat-label">Cr√≠ticos</div>
                                </div>
                            </div>
                        `;
                    }
                    break;

                case 'employees':
                    const dashResult = await invoke('get_dashboard_stats', { payload: { token } }) as any;
                    if (dashResult.success) {
                        reportTitle!.textContent = 'üë• Relat√≥rio de Funcion√°rios';
                        reportContent!.innerHTML = `
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-value">${dashResult.data.activeEmployees}</div>
                                    <div class="stat-label">Ativos</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${dashResult.data.terminatedEmployees}</div>
                                    <div class="stat-label">Demitidos</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">${dashResult.data.archiveBoxes}</div>
                                    <div class="stat-label">Caixas Arquivo Morto</div>
                                </div>
                            </div>
                        `;
                    }
                    break;
            }
        } catch (err) {
            console.error('Failed to load report:', err);
            reportContent!.innerHTML = 'Erro ao carregar relat√≥rio';
        }
    }
</script>
